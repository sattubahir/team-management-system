<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authentication</title>
    <script
      data-tiramai="web-gen"
      src="lib/tailwindcss/tailwindcss.js"
      fetchpriority="high"
    ></script>
    <link
      data-tiramai="web-gen"
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"
    />
    <link
      data-tiramai="web-gen"
      rel="icon"
      href="assets/imgs/logo.ico"
      type="image/x-icon"
    />
    <script data-tiramai="web-gen" type="module" src="scripts/main.js"></script>
    <!-- Custom Tailwind Configuration -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', 'sans-serif']
            },
            colors: {
              primary: '#2563EB',
              'primary-light': '#60A5FA',
              'primary-dark': '#1E40AF',
              secondary: '#475569',
              'secondary-light': '#64748B',
              'secondary-dark': '#334155',
              accent: '#059669',
              'accent-light': '#10B981',
              'accent-dark': '#047857',
              neutral: {
                100: '#F8FAFC',
                200: '#F1F5F9',
                300: '#E2E8F0',
                400: '#CBD5E1',
                500: '#94A3B8',
                600: '#64748B',
                700: '#475569',
                800: '#334155',
                900: '#1E293B',
              },
              error: '#DC2626',
              success: '#16A34A',
              warning: '#F59E0B',
            },
          },
        },
      };
    </script>
    <style>
      .bg-pattern {
        background-color: #F8FAFC;
        background-image: 
          linear-gradient(135deg, #EFF6FF 25%, transparent 25%),
          linear-gradient(225deg, #EFF6FF 25%, transparent 25%),
          linear-gradient(45deg, #EFF6FF 25%, transparent 25%),
          linear-gradient(315deg, #EFF6FF 25%, #F8FAFC 25%);
        background-position: 40px 0, 40px 0, 0 0, 0 0;
        background-size: 80px 80px;
        background-repeat: repeat;
      }
    </style>
  </head>
  <body class="bg-neutral-100 text-neutral-900 relative">
    <div class="w-screen h-screen bg-pattern absolute top-0 left-0 -z-10"></div>
    <main class="w-screen h-screen p-4 lg:p-10 z-10 flex flex-col">
      <div
        class="grid grid-cols-1 md:grid-cols-12 gap-8 items-center justify-center h-full"
      >
        <!-- Info Card -->
        <div
          class="hidden md:col-span-6 xl:col-span-7 md:flex flex-col justify-center items-center w-full h-full"
        >
          <!-- app name and logo -->
          <div class="w-full flex items-center gap-3 mt-10 mb-auto">
            <svg
              id="app-logo"
              width="40"
              height="40"
              viewBox="0 0 400 400"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle cx="200" cy="200" r="100" stroke="#2563EB" stroke-width="16" fill="none"/>
              <circle cx="120" cy="170" r="22" fill="#2563EB"/>
              <circle cx="280" cy="170" r="22" fill="#2563EB"/>
              <circle cx="200" cy="255" r="22" fill="#2563EB"/>
              <line x1="136" y1="182" x2="184" y2="242" stroke="#475569" stroke-width="10" stroke-linecap="round"/>
              <line x1="264" y1="182" x2="216" y2="242" stroke="#475569" stroke-width="10" stroke-linecap="round"/>
              <line x1="142" y1="176" x2="258" y2="176" stroke="#475569" stroke-width="10" stroke-linecap="round"/>
              <rect x="170" y="150" width="60" height="60" rx="8" stroke="#2563EB" stroke-width="10" fill="white"/>
            </svg>
            <h1
              id="app-name-main"
              class="text-4xl leading-[2rem] font-semibold text-primary"
            >
              Internal Team Management System
            </h1>
          </div>

          <div class="w-full mt-auto mb-10 p-2">
            <h2
              id="persona-name"
              class="text-2xl font-bold mb-6 rounded capitalize text-primary"
            >
              Team Administrator
            </h2>
            <p id="description" class="text-lg text-muted-foreground mb-8">
              Streamline internal team operations with centralized management of roles, teams, and members. Define organizational structure, track team composition, and maintain accurate personnel records. Built for administrators who need efficient oversight and precise team coordination.
            </p>
          </div>
        </div>

        <!-- Auth Card -->
        <div
          class="col-span-12 md:col-span-6 xl:col-span-5 w-full h-fit lg:h-full bg-white md:border border-border rounded-2xl shadow-sm flex flex-col justify-center items-center"
        >
          <div class="w-full p-6 lg:px-20 lg:pt-14 lg:pb-0 my-auto">
            <p
              class="text-center text-2xl font-bold mb-2 text-primary"
              id="greeting-text"
            >
              Sign in to Internal Team Management System
            </p>
            <p class="text-center text-lg mb-6" id="app-name-sub">
              Internal Team Management System
            </p>

            <!-- Phone Auth View -->
            <div id="phone-auth-view" class="hidden">
              <form id="phone-number-form" class="space-y-4">
                <div>
                  <label
                    for="phone-number"
                    class="block text-sm font-medium mb-1"
                  >
                    Phone Number
                  </label>
                  <div class="flex">
                    <select
                      id="country-code"
                      class="px-3 py-2 border border-border rounded-l-lg bg-background focus:outline-none focus:ring-0 border-r-0"
                    >
                      <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                      <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                      <option value="+91">ðŸ‡®ðŸ‡³ +91</option>
                      <option value="+86">ðŸ‡¨ðŸ‡³ +86</option>
                      <option value="+49">ðŸ‡©ðŸ‡ª +49</option>
                      <option value="+33">ðŸ‡«ðŸ‡· +33</option>
                      <option value="+81">ðŸ‡¯ðŸ‡µ +81</option>
                      <option value="+61">ðŸ‡¦ðŸ‡º +61</option>
                      <option value="+55">ðŸ‡§ðŸ‡· +55</option>
                      <option value="+7">ðŸ‡·ðŸ‡º +7</option>
                    </select>
                    <input
                      type="tel"
                      id="phone-number"
                      name="phone"
                      class="flex-1 px-3 py-2 border border-border rounded-r-lg bg-background focus:outline-none focus:ring-0"
                      placeholder="(555) 123-4567"
                      required
                    />
                  </div>
                </div>
                <button
                  type="submit"
                  class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:opacity-90 transition-opacity"
                >
                  Send Verification Code
                </button>
              </form>

              <!-- reCAPTCHA container -->
              <div id="recaptcha-container"></div>

              <!-- social login view for phone auth -->
              <div id="social-login-view-phone" class="hidden">
                <!-- separator -->
                <div
                  id="social-login-separator"
                  class="mt-6 flex items-center justify-center gap-4 px-4"
                >
                  <div class="w-full h-[1px] bg-gray-300"></div>
                  <span class="text-gray-500">or</span>
                  <div class="w-full h-[1px] bg-gray-300"></div>
                </div>

                <!-- Social Login Buttons -->
                <div class="mt-6 flex items-center justify-center gap-4 px-4">
                  <button
                    id="google-signin-button"
                    class="btn-google w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    <svg class="w-5 h-5" viewBox="0 0 48 48">
                      <path
                        fill="#FFC107"
                        d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
                      ></path>
                      <path
                        fill="#FF3D00"
                        d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
                      ></path>
                      <path
                        fill="#4CAF50"
                        d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
                      ></path>
                      <path
                        fill="#1976D2"
                        d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,36.219,44,30.561,44,24C44,22.659,43.862,21.35,43.611,20.083z"
                      ></path>
                    </svg>
                  </button>
                  <button
                    id="apple-signin-button"
                    class="btn-apple w-full flex items-center justify-center gap-2 bg-black text-white border border-black py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors"
                  >
                    <i class="ti ti-brand-apple-filled w-5 h-5"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Phone Verification View -->
            <div id="phone-verification-view" class="hidden">
              <div class="space-y-4">
                <div class="text-center">
                  <h3 class="text-lg font-medium mb-2">
                    Enter Verification Code
                  </h3>
                  <p class="text-sm text-muted-foreground mb-4">
                    We sent a 6-digit code to
                    <span id="sent-phone-number" class="font-medium"></span>
                  </p>
                </div>

                <!-- 6-digit OTP Input -->
                <div class="flex justify-center gap-2 mb-4">
                  <input
                    type="text"
                    maxlength="1"
                    class="otp-input w-12 h-12 text-center text-lg font-bold border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    data-index="0"
                  />
                  <input
                    type="text"
                    maxlength="1"
                    class="otp-input w-12 h-12 text-center text-lg font-bold border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    data-index="1"
                  />
                  <input
                    type="text"
                    maxlength="1"
                    class="otp-input w-12 h-12 text-center text-lg font-bold border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    data-index="2"
                  />
                  <input
                    type="text"
                    maxlength="1"
                    class="otp-input w-12 h-12 text-center text-lg font-bold border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    data-index="3"
                  />
                  <input
                    type="text"
                    maxlength="1"
                    class="otp-input w-12 h-12 text-center text-lg font-bold border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    data-index="4"
                  />
                  <input
                    type="text"
                    maxlength="1"
                    class="otp-input w-12 h-12 text-center text-lg font-bold border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    data-index="5"
                  />
                </div>

                <button
                  id="verify-code-button"
                  class="w-full bg-primary text-primary-foreground py-2 px-4 rounded-lg hover:opacity-90 transition-opacity"
                  disabled
                >
                  Verify Code
                </button>

                <!-- Resend Code -->
                <div class="text-center">
                  <p class="text-sm text-muted-foreground">
                    Didn't receive the code?
                    <button
                      id="resend-code-button"
                      class="text-primary hover:underline disabled:opacity-50 disabled:cursor-not-allowed ml-1"
                      disabled
                    >
                      Resend (<span id="resend-timer">30</span>s)
                    </button>
                  </p>
                </div>

                <!-- Back Link -->
                <div class="text-center">
                  <a
                    href="#"
                    id="verification-back-link"
                    class="text-primary hover:underline"
                  >
                    &larr; Change phone number
                  </a>
                </div>
              </div>
            </div>

            <!-- Email Login View -->
            <div id="email-login-view" class="hidden">
              <!-- Sign In Form -->
              <form id="signin-form" class="space-y-4">
                <div>
                  <label
                    for="signin-email"
                    class="block text-sm font-medium mb-1"
                  >
                    Email
                  </label>
                  <input
                    type="email"
                    id="signin-email"
                    name="email"
                    class="w-full px-3 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="name@example.com"
                    required
                  />
                </div>
                <div>
                  <label
                    for="signin-password"
                    class="text-sm font-medium mb-1 flex items-center justify-between"
                  >
                    Password
                    <a
                      href="#forgot-password-form"
                      id="forgot-password-link"
                      class="text-secondary hover:underline"
                    >
                      Forgot Password?
                    </a>
                  </label>
                  <input
                    type="password"
                    id="signin-password"
                    name="password"
                    class="w-full px-3 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="Password"
                    required
                  />
                </div>
                <button
                  id="signin-button"
                  type="submit"
                  class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:opacity-90 transition-opacity"
                >
                  Sign in as team administrator
                </button>
              </form>

              <!-- Sign Up Form -->
              <form id="signup-form" class="hidden space-y-4">
                <!-- Similar structure to sign in form -->
                <div class="flex items-center justify-center gap-4 w-full">
                  <div class="w-1/2">
                    <label
                      for="signup-first-name"
                      class="block text-sm font-medium mb-1"
                    >
                      First Name
                    </label>
                    <input
                      type="text"
                      id="signup-first-name"
                      name="first-name"
                      class="w-full px-3 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                      placeholder="John"
                      required
                    />
                  </div>
                  <div class="w-1/2">
                    <label
                      for="signup-last-name"
                      class="block text-sm font-medium mb-1"
                    >
                      Last Name
                    </label>
                    <input
                      type="text"
                      id="signup-last-name"
                      name="last-name"
                      class="w-full px-3 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                      placeholder="Doe"
                      required
                    />
                  </div>
                </div>
                <div>
                  <label
                    for="signup-email"
                    class="block text-sm font-medium mb-1"
                  >
                    Email
                  </label>
                  <input
                    type="email"
                    id="signup-email"
                    name="email"
                    class="w-full px-3 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="name@example.com"
                    required
                  />
                </div>
                <div>
                  <label
                    for="signup-password"
                    class="block text-sm font-medium mb-1"
                  >
                    Password
                  </label>
                  <input
                    type="password"
                    id="signup-password"
                    name="password"
                    class="w-full px-3 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="Password"
                    required
                  />
                </div>
                <div>
                  <label
                    for="signup-confirm-password"
                    class="block text-sm font-medium mb-1"
                  >
                    Confirm Password
                  </label>
                  <input
                    type="password"
                    id="signup-confirm-password"
                    name="confirm-password"
                    class="w-full px-3 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="Confirm Password"
                    required
                  />
                </div>
                <button
                  id="signup-button"
                  type="submit"
                  class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:opacity-90 transition-opacity"
                >
                  Sign up as team administrator
                </button>
              </form>

              <!-- Forgot Password Form -->
              <form id="forgot-password-form" class="hidden space-y-4">
                <div>
                  <label
                    for="forgot-password-email"
                    class="block text-sm font-medium mb-1"
                  >
                    Email
                  </label>
                  <input
                    type="email"
                    id="forgot-password-email"
                    name="email"
                    class="w-full px-3 py-2 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
                    placeholder="name@example.com"
                    required
                  />
                </div>
                <button
                  type="submit"
                  class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:opacity-90 transition-opacity"
                >
                  Reset Password
                </button>
              </form>

              <!-- social login view for phone auth -->
              <div id="social-login-view-email" class="hidden">
                <!-- separator -->
                <div
                  id="social-login-separator"
                  class="mt-6 flex items-center justify-center gap-4 px-4"
                >
                  <div class="w-full h-[1px] bg-gray-300"></div>
                  <span class="text-gray-500">or</span>
                  <div class="w-full h-[1px] bg-gray-300"></div>
                </div>

                <!-- Social Login Buttons -->
                <div class="mt-6 flex items-center justify-center gap-4 px-4">
                  <button
                    id="google-signin-button"
                    class="btn-google w-full flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    <svg class="w-5 h-5" viewBox="0 0 48 48">
                      <path
                        fill="#FFC107"
                        d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
                      ></path>
                      <path
                        fill="#FF3D00"
                        d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
                      ></path>
                      <path
                        fill="#4CAF50"
                        d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
                      ></path>
                      <path
                        fill="#1976D2"
                        d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,36.219,44,30.561,44,24C44,22.659,43.862,21.35,43.611,20.083z"
                      ></path>
                    </svg>
                  </button>
                  <button
                    id="apple-signin-button"
                    class="btn-apple w-full flex items-center justify-center gap-2 bg-black text-white border border-black py-2 px-4 rounded-lg hover:bg-gray-800 transition-colors"
                  >
                    <i class="ti ti-brand-apple-filled w-5 h-5"></i>
                  </button>
                </div>
              </div>

              <!-- Form Navigation Links -->
              <div class="mt-6 text-center space-y-2">
                <p id="signup-link">
                  Don't have an account?
                  <a href="#signup-form" class="text-secondary hover:underline">
                    Sign Up
                  </a>
                </p>
                <p id="signin-link" class="hidden">
                  Already have an account?
                  <a href="#signin-form" class="text-secondary hover:underline">
                    Sign In
                  </a>
                </p>
              </div>
            </div>
          </div>

          <div class="mt-auto mb-4 lg:mb-10 flex flex-col items-center">
            <p class="text-sm text-muted-foreground">
              By continuing, you agree to our
            </p>
            <p class="flex items-center gap-2 mb-8">
              <a
                href="https://www.tiram.ai/terms-of-service.html"
                target="_blank"
                class="text-primary hover:underline"
              >
                Terms of Service
              </a>
              and
              <a
                href="https://www.tiram.ai/privacy-policy.html"
                target="_blank"
                class="text-primary hover:underline"
              >
                Privacy Policy
              </a>
              .
            </p>
            <div class="flex items-center">
              Â© <span id="rights-year">2024</span>
              <a
                href="http://www.zpqv.com"
                target="_blank"
                class="mx-2 text-primary hover:underline"
              >
                zpqv
              </a>
              Inc. All rights reserved.
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import {
        showLoader,
        hideLoader,
        env,
        showToast,
      } from './scripts/main.js';
      import { auth, getDb } from './scripts/firebase.js';
      import {
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        sendEmailVerification,
        sendPasswordResetEmail,
        GoogleAuthProvider,
        OAuthProvider,
        signInWithPopup,
        RecaptchaVerifier,
        signInWithPhoneNumber,
      } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';

      import {
        setDoc,
        doc,
        updateDoc,
      } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-lite.js';

      const db = getDb('crud'); // returns full db
      document.addEventListener('DOMContentLoaded', function () {
        // Handle view switching based on feature flags
        if (env.PHONE_AUTH_ENABLED) {
          document.getElementById('phone-auth-view').classList.remove('hidden');
          if (env.SOCIAL_LOGIN_ENABLED) {
            document
              .getElementById('social-login-view-phone')
              .classList.remove('hidden');
          }
        } else {
          document
            .getElementById('email-login-view')
            .classList.remove('hidden');

          if (env.SOCIAL_LOGIN_ENABLED) {
            document
              .getElementById('social-login-view-email')
              .classList.remove('hidden');
          }
        }

        // Auto-fill credentials in development mode
        if (env?.ENVIRONMENT?.toLowerCase()?.includes('dev')) {
          document.getElementById('signin-email').value = 'johndoe@example.com';
          document.getElementById('signin-password').value = 'JohnDoe@2023';
        }

        const year = new Date().getFullYear();
        document.getElementById('rights-year').textContent = year;

        // Social Login Buttons
        document
          .querySelectorAll('.btn-google')
          .forEach((el) => el.addEventListener('click', signInWithGoogle));
        document
          .querySelectorAll('.btn-apple')
          .forEach((el) => el.addEventListener('click', signInWithApple));

        document
          .getElementById('verification-back-link')
          .addEventListener('click', function (e) {
            e.preventDefault();
            showPhoneAuth();
          });

        // Sign In Form
        document
          .getElementById('signin-form')
          .addEventListener('submit', function (event) {
            event.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            signIn(email, password);
          });

        // Sign Up Form
        document
          .getElementById('signup-form')
          .addEventListener('submit', function (event) {
            event.preventDefault();
            const firstName =
              document.getElementById('signup-first-name').value;
            const lastName = document.getElementById('signup-last-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById(
              'signup-confirm-password',
            ).value;

            if (password !== confirmPassword) {
              alert('Passwords do not match');
              return;
            }

            signUp(firstName, lastName, email, password);
          });

        // Forgot Password Form
        document
          .getElementById('forgot-password-form')
          .addEventListener('submit', function (event) {
            event.preventDefault();
            const email = document.getElementById(
              'forgot-password-email',
            ).value;
            resetPassword(email);
          });

        // Phone Number Form
        document
          .getElementById('phone-number-form')
          .addEventListener('submit', function (event) {
            event.preventDefault();
            const countryCode = document.getElementById('country-code').value;
            const phoneNumber = document.getElementById('phone-number').value;
            const fullPhoneNumber =
              countryCode + phoneNumber.replace(/\D/g, '');
            sendVerificationCode(fullPhoneNumber);
          });

        // Phone Verification Code Button
        document
          .getElementById('verify-code-button')
          .addEventListener('click', function () {
            verifyPhoneCode();
          });

        // Resend Code Button
        document
          .getElementById('resend-code-button')
          .addEventListener('click', function () {
            if (!this.disabled) {
              resendVerificationCode();
            }
          });

        // OTP Input Auto-focus Logic
        setupOTPInputs();

        // Password confirmation validation
        document
          .getElementById('signup-confirm-password')
          .addEventListener('input', function () {
            const password = document.getElementById('signup-password').value;
            const confirmPassword = this.value;
            if (password !== confirmPassword) {
              this.setCustomValidity('Passwords do not match');
            } else {
              this.setCustomValidity('');
            }
          });

        formSwitch();
      });

      window.addEventListener('hashchange', formSwitch);

      function formSwitch() {
        if (window.location.hash === '#forgot-password-form') {
          showForgotPassword();
        }
        if (window.location.hash === '#signup-form') {
          showSignUp();
        }
        if (window.location.hash === '#signin-form') {
          showSignIn();
        }
      }

      /**
       * Get the redirect URL from query parameters or default to admin_dashboard.html
       * @returns {string} The URL to redirect to after successful authentication
       */
      function getRedirectUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect');

        // Validate the redirect URL to prevent potential security issues
        if (redirect) {
          try {
            // Check if it's a relative URL (starts with ./ or just filename)
            if (
              redirect.startsWith('./') ||
              /^[a-zA-Z0-9_-]+\.html$/.test(redirect)
            ) {
              return redirect;
            }
            // Check if it's an absolute URL from the same origin
            const redirectUrl = new URL(redirect, window.location.origin);
            if (redirectUrl.origin === window.location.origin) {
              return (
                redirectUrl.pathname + redirectUrl.search + redirectUrl.hash
              );
            }
          } catch (error) {
            console.warn('Invalid redirect URL provided:', redirect);
          }
        }

        // Default to admin_dashboard.html if no valid redirect is provided
        return 'admin_dashboard.html';
      }

      function signIn(email, password) {
        showLoader('Signing you in... Please wait...');
        signInWithEmailAndPassword(auth, email, password)
          .then((userCredential) => {
            const user = userCredential.user;

            if (email !== 'johndoe@example.com' && !user.emailVerified) {
              hideLoader();
              alert(
                'Your email address has not been verified. Please check your inbox for a verification link.',
              );

              // Offer to resend verification email
              if (
                confirm('Would you like us to resend the verification email?')
              ) {
                sendEmailVerification(user)
                  .then(() => {
                    alert(
                      'A new verification email has been sent to your address.',
                    );
                  })
                  .catch((error) => {
                    console.error('Error resending verification email:', error);
                    alert(
                      'Failed to resend verification email: ' + error.message,
                    );
                  });
              }
              return; // Stop the login process
            }

            user.getIdToken().then(async (idToken) => {
              // Cache auth state for smooth subsequent loads
              localStorage.setItem('lastAuthState', 'authenticated');
              localStorage.setItem('lastAuthTime', Date.now().toString());

              hideLoader();

              // update last login time
              try {
                const userRef = doc(db, 'users', user.uid);
                await updateDoc(userRef, {
                  lastLoginAt: new Date().toISOString(),
                });
              } catch (e) {
                console.warn('Non-blocking: failed to update lastLoginAt', e);
              }
              // Redirect to the specified URL or default to admin_dashboard.html
              const redirectUrl = getRedirectUrl();
              showToast('Welcome back! Redirecting...', 'success');
              window.location.href = redirectUrl;
            });
          })
          .catch((error) => {
            console.error('Error signing in:', error);
            alert('Error signing in. Please check your email and password.');
            hideLoader();
          });
      }

      function signUp(firstName, lastName, email, password) {
        showLoader('Creating your account... Please wait...');
        createUserWithEmailAndPassword(auth, email, password)
          .then(async (userCredential) => {
            const user = userCredential.user;
            const userData = {
              uid: user.uid,
              firstName,
              lastName,
              email,
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
              lastLoginAt: new Date().toISOString(),
            };
            // sign-up (create profile)
            try {
              await setDoc(doc(db, 'users', user.uid), userData);
            } catch (e) {
              console.error('Failed to create user profile:', e);
            }
            sendEmailVerification(user).then(() => {
              alert(
                'Account created successfully. Please check your email to verify your account.',
              );
              showSignIn();
              hideLoader();
            });
          })
          .catch((error) => {
            console.error('Error signing up:', error);
            alert('Error creating account. ' + error.message);
            hideLoader();
          });
      }

      function resetPassword(email) {
        showLoader('Resetting your password... Please wait...');
        sendPasswordResetEmail(auth, email)
          .then(() => {
            alert('Password reset email sent. Please check your inbox.');
            showSignIn();
            hideLoader();
          })
          .catch((error) => {
            console.error('Error resetting password:', error);
            alert('Error resetting password. ' + error.message);
            hideLoader();
          });
      }

      function signInWithGoogle() {
        const provider = new GoogleAuthProvider();
        handleSocialSignIn(provider);
      }

      function signInWithApple() {
        const provider = new OAuthProvider('apple.com');
        handleSocialSignIn(provider);
      }

      function handleSocialSignIn(provider) {
        showLoader('Connecting to provider... Please wait...');
        signInWithPopup(auth, provider)
          .then((result) => {
            const user = result.user;
            user.getIdToken().then(async (idToken) => {
              localStorage.setItem('idToken', idToken);
              localStorage.setItem('refreshToken', user.refreshToken);
              localStorage.setItem('lastAuthState', 'authenticated');
              localStorage.setItem('lastAuthTime', Date.now().toString());

              // update last login time
              try {
                const userRef = doc(db, 'users', user.uid);
                await updateDoc(userRef, {
                  uid: user.uid,
                  firstName: user.displayName?.split(' ')[0] || '',
                  lastName:
                    user.displayName?.split(' ')?.slice(1).join(' ') || '',
                  email: user.email,
                  updatedAt: new Date().toISOString(),
                  lastLoginAt: new Date().toISOString(),
                });
              } catch {
                try {
                  await setDoc(doc(db, 'users', user.uid), {
                    uid: user.uid,
                    firstName: user.displayName?.split(' ')[0] || '',
                    lastName:
                      user.displayName?.split(' ')?.slice(1).join(' ') || '',
                    email: user.email,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastLoginAt: new Date().toISOString(),
                  });
                } catch (e2) {
                  console.error('Failed to upsert user profile:', e2);
                }
              }

              hideLoader();
              // Redirect to the specified URL or default to admin_dashboard.html
              const redirectUrl = getRedirectUrl();
              showToast('Welcome back! Redirecting...', 'success');
              window.location.href = redirectUrl;
            });
          })
          .catch((error) => {
            hideLoader();
            console.error('Social sign-in error:', error);
            alert(`Error with social sign-in: ${error.message}`);
          });
      }

      // Phone Auth View Management Functions
      function showPhoneAuth() {
        hideAllViews();
        document.getElementById('phone-auth-view').classList.remove('hidden');
        document.getElementById('greeting-text').textContent =
          'Enter your phone number';

        // Initialize reCAPTCHA if not already done
        if (!window.recaptchaVerifier) {
          initializeRecaptcha();
        }
      }

      function showPhoneVerification(phoneNumber) {
        hideAllViews();
        document
          .getElementById('phone-verification-view')
          .classList.remove('hidden');
        document.getElementById('sent-phone-number').textContent = phoneNumber;
        document.getElementById('greeting-text').textContent =
          'Verify your phone number';

        // Focus on first OTP input
        document.querySelector('.otp-input[data-index="0"]').focus();

        // Start resend timer
        startResendTimer();
      }

      function hideAllViews() {
        document.getElementById('email-login-view').classList.add('hidden');
        document.getElementById('phone-auth-view').classList.add('hidden');
        document
          .getElementById('phone-verification-view')
          .classList.add('hidden');
        document
          .getElementById('social-login-view-email')
          ?.classList.add('hidden');
        document
          .getElementById('social-login-view-phone')
          ?.classList.add('hidden');
      }

      // OTP Input Management
      function setupOTPInputs() {
        const otpInputs = document.querySelectorAll('.otp-input');

        otpInputs.forEach((input, index) => {
          input.addEventListener('input', function (e) {
            // Only allow numbers
            this.value = this.value.replace(/[^0-9]/g, '');

            // Auto-focus next input
            if (this.value.length === 1 && index < otpInputs.length - 1) {
              otpInputs[index + 1].focus();
            }

            // Enable/disable verify button based on completion
            checkOTPCompletion();
          });

          input.addEventListener('keydown', function (e) {
            // Handle backspace to go to previous input
            if (e.key === 'Backspace' && this.value === '' && index > 0) {
              otpInputs[index - 1].focus();
            }
          });

          input.addEventListener('paste', function (e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text');
            const digits = pastedData.replace(/[^0-9]/g, '').slice(0, 6);

            // Fill inputs with pasted digits
            digits.split('').forEach((digit, i) => {
              if (i < otpInputs.length) {
                otpInputs[i].value = digit;
              }
            });

            // Focus on the next empty input or the last one
            const nextEmptyIndex = Math.min(
              digits.length,
              otpInputs.length - 1,
            );
            otpInputs[nextEmptyIndex].focus();

            checkOTPCompletion();
          });
        });
      }

      function checkOTPCompletion() {
        const otpInputs = document.querySelectorAll('.otp-input');
        const verifyButton = document.getElementById('verify-code-button');

        const isComplete = Array.from(otpInputs).every(
          (input) => input.value.length === 1,
        );
        verifyButton.disabled = !isComplete;
      }

      function getOTPCode() {
        const otpInputs = document.querySelectorAll('.otp-input');
        return Array.from(otpInputs)
          .map((input) => input.value)
          .join('');
      }

      function clearOTPInputs() {
        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach((input) => (input.value = ''));
        otpInputs[0].focus();
        checkOTPCompletion();
      }

      // Phone Authentication Functions
      let confirmationResult = null;
      let currentPhoneNumber = null;

      function initializeRecaptcha() {
        if (window.recaptchaVerifier) return;
        window.recaptchaVerifier = new RecaptchaVerifier(
          auth,
          'recaptcha-container',
          {
            size: 'invisible',
            callback: () => {},
            'expired-callback': () => {
              try {
                window.recaptchaVerifier.clear();
              } catch {}
              window.recaptchaVerifier = null;
            },
          },
        );
      }

      function sendVerificationCode(phoneNumber) {
        showLoader('Sending verification code... Please wait...');
        currentPhoneNumber = phoneNumber;

        signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
          .then((result) => {
            confirmationResult = result;
            hideLoader();
            showPhoneVerification(phoneNumber);
            showToast('Verification code sent successfully!', 'success');
          })
          .catch((error) => {
            hideLoader();
            console.error('Error sending verification code:', error);

            // Reset reCAPTCHA on error
            if (window.recaptchaVerifier) {
              try {
                window.recaptchaVerifier.clear();
              } catch {}
              window.recaptchaVerifier = null;
            }
            initializeRecaptcha();

            alert('Error sending verification code: ' + error.message);
          });
      }

      function verifyPhoneCode() {
        const code = getOTPCode();
        if (code.length !== 6) {
          alert('Please enter the complete 6-digit code.');
          return;
        }

        showLoader('Verifying code... Please wait...');

        confirmationResult
          .confirm(code)
          .then((result) => {
            const user = result.user;
            user.getIdToken().then((idToken) => {
              localStorage.setItem('idToken', idToken);
              localStorage.setItem('refreshToken', user.refreshToken);
              localStorage.setItem('lastAuthState', 'authenticated');
              localStorage.setItem('lastAuthTime', Date.now().toString());
              hideLoader();
              showToast('Phone number verified successfully!', 'success');
              // Redirect to the specified URL or default to admin_dashboard.html
              const redirectUrl = getRedirectUrl();
              setTimeout(() => {
                window.location.href = redirectUrl;
              }, 1000); // Small delay to show the success toast
            });
          })
          .catch((error) => {
            hideLoader();
            console.error('Error verifying code:', error);
            alert('Invalid verification code. Please try again.');
            clearOTPInputs();
          });
      }

      function resendVerificationCode() {
        if (currentPhoneNumber) {
          sendVerificationCode(currentPhoneNumber);
        }
      }

      // Resend Timer Management
      function startResendTimer() {
        const resendButton = document.getElementById('resend-code-button');
        const timerSpan = document.getElementById('resend-timer');
        let timeLeft = 30;

        resendButton.disabled = true;

        const timer = setInterval(() => {
          timeLeft--;
          timerSpan.textContent = timeLeft;

          if (timeLeft <= 0) {
            clearInterval(timer);
            resendButton.disabled = false;
            resendButton.innerHTML = 'Resend';
          }
        }, 1000);
      }

      function showSignIn() {
        document.getElementById('signin-form').classList.remove('hidden');
        document.getElementById('signup-form').classList.add('hidden');
        document.getElementById('forgot-password-form').classList.add('hidden');
        document.getElementById('signup-link').classList.remove('hidden');
        document.getElementById('signin-link').classList.add('hidden');
        document
          .getElementById('forgot-password-link')
          .classList.remove('hidden');
        document.getElementById('greeting-text').textContent = 'Sign in to Internal Team Management System';
      }

      function showSignUp() {
        document.getElementById('signin-form').classList.add('hidden');
        document.getElementById('signup-form').classList.remove('hidden');
        document.getElementById('forgot-password-form').classList.add('hidden');
        document.getElementById('signup-link').classList.add('hidden');
        document.getElementById('signin-link').classList.remove('hidden');
        document.getElementById('forgot-password-link').classList.add('hidden');
        document.getElementById('greeting-text').textContent =
          'Create your Internal Team Management System account';
      }

      function showForgotPassword() {
        document.getElementById('signin-form').classList.add('hidden');
        document.getElementById('signup-form').classList.add('hidden');
        document
          .getElementById('forgot-password-form')
          .classList.remove('hidden');
        document.getElementById('signup-link').classList.add('hidden');
        document.getElementById('signin-link').classList.remove('hidden');
        document.getElementById('forgot-password-link').classList.add('hidden');
        document.getElementById('greeting-text').textContent =
          'Reset your Internal Team Management System password';
      }
    </script>
  </body>
</html>