<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Internal Team Management System</title>

  <!-- Required: Main JS Script -->
  <script type="module" src="scripts/main.js" data-tiramai="web-gen"></script>

  <!-- Required: TailwindCSS -->
  <script src="./lib/tailwindcss/tailwindcss.js" fetchpriority="high" data-tiramai="web-gen"></script>

  <!-- Required: Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest" data-tiramai="web-gen"></script>

  <!-- Required: Favicon -->
  <link rel="icon" href="assets/imgs/logo.png" type="image/x-icon" data-tiramai="web-gen" />

  <!-- ECharts Support (for charts/graphs) -->
  <script defer src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js" data-tiramai="web-gen"></script>

  <!-- Markdown Support (for content rendering) -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" data-tiramai="web-gen"></script>

  <script data-tiramai="web-gen">
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', 'sans-serif']
          },
          colors: {
            'brand-primary': '#2563EB',
            'brand-secondary': '#475569',
            'brand-accent': '#059669',
            'brand-surface': '#FFFFFF',
            'brand-background': '#F8FAFC',
            'brand-border': '#E2E8F0',
            'brand-text-primary': '#0B1220',
            'brand-text-secondary': '#111827'
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --sidebar-width: 16rem;
    }

    /* w-64 */
    @media (min-width: 768px) {
      #pageContent {
        margin-left: var(--sidebar-width) !important;
      }

      /* optionally ensure the inner container uses full width to the right of sidebar */
      #pageContent>.container,
      #pageContent>.max-w-screen-xl {
        margin-left: 0;
      }
    }
  </style>

</head>

<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">
  <!-- Top Navigation -->
  <header
    class="fixed top-0 left-0 right-0 bg-white border-b border-slate-200 flex items-center justify-between px-6 py-4 z-30 h-16">
    <div class="flex items-center gap-4">
      <svg width="32" height="32" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8">
        <circle cx="200" cy="200" r="100" stroke="#2563EB" stroke-width="16" fill="none" />
        <circle cx="120" cy="170" r="22" fill="#2563EB" />
        <circle cx="280" cy="170" r="22" fill="#2563EB" />
        <circle cx="200" cy="255" r="22" fill="#2563EB" />
        <line x1="136" y1="182" x2="184" y2="242" stroke="#475569" stroke-width="10" stroke-linecap="round" />
        <line x1="264" y1="182" x2="216" y2="242" stroke="#475569" stroke-width="10" stroke-linecap="round" />
        <line x1="142" y1="176" x2="258" y2="176" stroke="#475569" stroke-width="10" stroke-linecap="round" />
        <rect x="170" y="150" width="60" height="60" rx="8" stroke="#2563EB" stroke-width="10" fill="white" />
      </svg>
      <span class="text-xl font-semibold text-slate-900">Internal Team Management System</span>
      <!-- Mobile Menu Toggle -->
      <button id="mobile-menu-toggle"
        class="md:hidden p-2 rounded text-slate-600 hover:text-slate-900 hover:bg-slate-100" aria-label="Toggle menu">
        <i data-lucide="menu" class="w-5 h-5"></i>
      </button>
    </div>

    <div class="flex items-center gap-4">
      <!-- User Profile Dropdown -->
      <div class="relative">
        <button id="user-profile-button"
          class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
          <div
            class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-semibold"
            id="user-avatar">
            U
          </div>
          <span id="user-display-name" class="hidden sm:block">Loading...</span>
          <i data-lucide="chevron-down" class="w-4 h-4"></i>
        </button>

        <!-- Dropdown Menu -->
        <div id="user-dropdown"
          class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 py-1 z-40 hidden">
          <div class="px-4 py-2 border-b border-slate-200">
            <p class="text-sm font-medium text-slate-900" id="dropdown-user-name">Loading...</p>
            <p class="text-xs text-slate-500" id="dropdown-user-email">Loading...</p>
          </div>
          <button id="sign-out-btn"
            class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-100 flex items-center gap-2">
            <i data-lucide="log-out" class="w-4 h-4"></i>
            Sign Out
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="flex pt-16">
    <!-- Side Navigation -->
    <aside id="sidebar"
      class="fixed md:static inset-y-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-in-out w-64 bg-white border-r border-slate-200 h-screen md:h-[calc(100vh-4rem)] overflow-y-auto z-20 top-16 md:top-0">
      <nav class="p-4 space-y-2">
        <!-- Admin Dashboard -->
        <a href="admin_dashboard.html"
          class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-slate-900 transition-colors"
          data-page="admin_dashboard">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
          <span>Admin Dashboard</span>
        </a>

        <!-- Team Management -->
        <div class="space-y-1">
          <a href="team_list.html"
            class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-slate-900 transition-colors"
            data-page="team_list">
            <i data-lucide="users" class="w-5 h-5"></i>
            <span>Team List</span>
          </a>
        </div>

        <!-- Member Management -->
        <div class="space-y-1">
          <a href="member_list.html"
            class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-slate-900 transition-colors"
            data-page="member_list">
            <i data-lucide="user" class="w-5 h-5"></i>
            <span>Member List</span>
          </a>
        </div>

        <!-- Role Management -->
        <div class="space-y-1">
          <a href="role_list.html"
            class="nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-slate-900 transition-colors"
            data-page="role_list">
            <i data-lucide="award" class="w-5 h-5"></i>
            <span>Role List</span>
          </a>
        </div>
      </nav>

      <!-- Footer -->
      <div class="absolute bottom-4 left-0 right-0 px-4">
        <div class="text-center text-xs text-slate-500 bg-white py-2">
          Made with ❤️ by TiramAi
        </div>
      </div>
    </aside>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden md:hidden"></div>

    <!-- Main Content -->
    <main id="pageContent" class="flex-1 p-6 h-screen overflow-y-auto md:ml-0">

      <!-- Team Detail Header -->
      <div class="bg-white rounded-lg shadow border border-slate-200 p-6 mb-6">
        <!-- Back Button and Header -->
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-4">
            <button id="btn-back"
              class="flex items-center gap-2 px-3 py-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors">
              <i data-lucide="arrow-left" class="w-5 h-5"></i>
              <span>Back to Teams</span>
            </button>
            <div class="h-6 w-px bg-slate-200"></div>
            <div>
              <h1 class="text-2xl leading-8 font-semibold text-slate-900" id="team-name">Loading...</h1>
              <p class="text-sm text-slate-500 mt-1" id="team-meta">Loading team details...</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="btn-refresh"
              class="inline-flex items-center px-3 py-2 text-sm text-slate-500 hover:text-slate-700 rounded-lg hover:bg-slate-100 transition-colors"
              aria-label="Refresh">
              <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
              Refresh
            </button>
            <button id="btn-edit-team"
              class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
              <i data-lucide="edit" class="w-4 h-4 mr-2"></i>
              Edit Team
            </button>
            <button id="btn-delete-team"
              class="inline-flex items-center px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
              <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
              Delete Team
            </button>
          </div>
        </div>
      </div>

      <!-- Team Members Section -->
      <div class="bg-white rounded-lg shadow border border-slate-200">
        <!-- Section Header -->
        <div class="p-6 border-b border-slate-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <h2 class="text-xl leading-7 font-semibold text-slate-900">Team Members</h2>
              <span id="member-count-badge"
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">0
                members</span>
            </div>
            <button id="btn-add-members"
              class="inline-flex items-center px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-lg hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-colors">
              <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
              Add Members
            </button>
          </div>
        </div>

        <!-- Members Table -->
        <div class="overflow-x-auto" id="members-table-container">
          <!-- Loading Skeleton -->
          <div id="members-skeleton" class="p-6">
            <div class="space-y-4">
              <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-slate-200 rounded-full animate-pulse"></div>
                <div class="flex-1">
                  <div class="h-4 bg-slate-200 rounded animate-pulse mb-2"></div>
                  <div class="h-3 bg-slate-200 rounded animate-pulse w-3/4"></div>
                </div>
                <div class="w-24 h-6 bg-slate-200 rounded animate-pulse"></div>
                <div class="w-16 h-8 bg-slate-200 rounded animate-pulse"></div>
              </div>
              <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-slate-200 rounded-full animate-pulse"></div>
                <div class="flex-1">
                  <div class="h-4 bg-slate-200 rounded animate-pulse mb-2"></div>
                  <div class="h-3 bg-slate-200 rounded animate-pulse w-3/4"></div>
                </div>
                <div class="w-24 h-6 bg-slate-200 rounded animate-pulse"></div>
                <div class="w-16 h-8 bg-slate-200 rounded animate-pulse"></div>
              </div>
              <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-slate-200 rounded-full animate-pulse"></div>
                <div class="flex-1">
                  <div class="h-4 bg-slate-200 rounded animate-pulse mb-2"></div>
                  <div class="h-3 bg-slate-200 rounded animate-pulse w-3/4"></div>
                </div>
                <div class="w-24 h-6 bg-slate-200 rounded animate-pulse"></div>
                <div class="w-16 h-8 bg-slate-200 rounded animate-pulse"></div>
              </div>
            </div>
          </div>

          <!-- Actual Table -->
          <table id="members-table" class="min-w-full divide-y divide-slate-200 hidden">
            <thead class="bg-slate-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                  Member
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                  Email
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                  Roles
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                  Joined
                </th>
                <th scope="col" class="relative px-6 py-3">
                  <span class="sr-only">Actions</span>
                </th>
              </tr>
            </thead>
            <tbody id="members-table-body" class="bg-white divide-y divide-slate-200">
              <!-- Table rows will be dynamically populated -->
            </tbody>
          </table>

          <!-- Empty State -->
          <div id="members-empty-state" class="text-center py-12 hidden">
            <div class="max-w-sm mx-auto">
              <div class="mx-auto h-12 w-12 text-slate-400">
                <i data-lucide="users" class="w-12 h-12"></i>
              </div>
              <h3 class="mt-2 text-sm font-medium text-slate-900">No team members</h3>
              <p class="mt-1 text-sm text-slate-500">Get started by adding members to this team.</p>
              <div class="mt-6">
                <button id="btn-add-members-empty"
                  class="inline-flex items-center px-4 py-2 bg-emerald-600 text-white text-sm font-medium rounded-lg hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-colors">
                  <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                  Add Members
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Members Modal -->
      <div id="modal-add-members" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
          <!-- Background overlay -->
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity" aria-hidden="true"></div>

          <!-- Modal panel -->
          <div
            class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <!-- Header -->
            <div class="bg-white px-6 py-4 border-b border-slate-200">
              <div class="flex items-center justify-between">
                <h3 class="text-lg leading-6 font-semibold text-slate-900" id="modal-title">
                  Add Members to Team
                </h3>
                <button id="btn-close-add-modal"
                  class="rounded-lg p-1 text-slate-400 hover:text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                  <i data-lucide="x" class="w-5 h-5"></i>
                </button>
              </div>
            </div>

            <!-- Modal Content -->
            <div class="bg-white px-6 py-4 max-h-96 overflow-y-auto">
              <!-- Search Bar -->
              <div class="mb-4">
                <label for="member-search" class="block text-sm font-medium text-slate-700 mb-2">Search Members</label>
                <div class="relative">
                  <input type="text" id="member-search" placeholder="Search by name or email..."
                    class="w-full px-3 py-2 pl-10 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                  <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-slate-400"></i>
                </div>
              </div>

              <!-- Select All Controls -->
              <div class="flex items-center justify-between mb-4 pb-2 border-b border-slate-200">
                <div class="flex items-center">
                  <input type="checkbox" id="select-all-members"
                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-slate-300 rounded">
                  <label for="select-all-members" class="ml-2 text-sm text-slate-700">Select All</label>
                </div>
                <div class="flex gap-2">
                  <button id="btn-select-all" class="text-xs text-blue-600 hover:text-blue-800 font-medium">Select
                    All</button>
                  <span class="text-slate-300">|</span>
                  <button id="btn-deselect-all" class="text-xs text-slate-600 hover:text-slate-800 font-medium">Deselect
                    All</button>
                </div>
              </div>

              <!-- Available Members List -->
              <div id="available-members-list">
                <!-- Loading skeleton -->
                <div id="available-members-skeleton" class="space-y-3">
                  <div class="flex items-center p-3 rounded-lg border border-slate-200">
                    <div class="w-4 h-4 bg-slate-200 rounded animate-pulse mr-3"></div>
                    <div class="w-8 h-8 bg-slate-200 rounded-full animate-pulse mr-3"></div>
                    <div class="flex-1">
                      <div class="h-4 bg-slate-200 rounded animate-pulse mb-1"></div>
                      <div class="h-3 bg-slate-200 rounded animate-pulse w-2/3"></div>
                    </div>
                  </div>
                  <div class="flex items-center p-3 rounded-lg border border-slate-200">
                    <div class="w-4 h-4 bg-slate-200 rounded animate-pulse mr-3"></div>
                    <div class="w-8 h-8 bg-slate-200 rounded-full animate-pulse mr-3"></div>
                    <div class="flex-1">
                      <div class="h-4 bg-slate-200 rounded animate-pulse mb-1"></div>
                      <div class="h-3 bg-slate-200 rounded animate-pulse w-2/3"></div>
                    </div>
                  </div>
                </div>

                <!-- Available members will be populated here -->
                <div id="available-members-container" class="hidden space-y-2">
                </div>

                <!-- No available members -->
                <div id="no-available-members" class="text-center py-8 hidden">
                  <i data-lucide="user-check" class="w-8 h-8 mx-auto text-slate-400 mb-2"></i>
                  <p class="text-sm text-slate-500">All members are already in this team</p>
                </div>

                <!-- No search results -->
                <div id="no-search-results" class="text-center py-8 hidden">
                  <i data-lucide="search" class="w-8 h-8 mx-auto text-slate-400 mb-2"></i>
                  <p class="text-sm text-slate-500">No members found matching your search</p>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="bg-slate-50 px-6 py-3 flex items-center justify-between">
              <div class="text-sm text-slate-500">
                <span id="selected-count">0</span> member(s) selected
              </div>
              <div class="flex gap-3">
                <button id="btn-cancel-add"
                  class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                  Cancel
                </button>
                <button id="btn-save-members"
                  class="px-4 py-2 text-sm font-medium text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>
                  Add Selected Members
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Team Modal -->
      <div id="modal-edit-team" class="fixed inset-0 z-50 hidden" aria-labelledby="edit-modal-title" role="dialog"
        aria-modal="true">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
          <!-- Background overlay -->
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity" aria-hidden="true"></div>

          <!-- Modal panel -->
          <div
            class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <!-- Header -->
            <div class="bg-white px-6 py-4 border-b border-slate-200">
              <div class="flex items-center justify-between">
                <h3 class="text-lg leading-6 font-semibold text-slate-900" id="edit-modal-title">
                  Edit Team
                </h3>
                <button id="btn-close-edit-modal"
                  class="text-slate-400 hover:text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded">
                  <i data-lucide="x" class="w-5 h-5"></i>
                </button>
              </div>
            </div>

            <!-- Content -->
            <div class="bg-white px-6 py-4">
              <div class="space-y-4">
                <div>
                  <label for="edit-team-name" class="block text-sm font-medium text-slate-900 mb-1">
                    Team Name
                  </label>
                  <input type="text" id="edit-team-name"
                    class="w-full px-3 py-2 border border-slate-300 rounded-lg text-slate-900 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Enter team name" />
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex justify-end gap-3">
              <button id="btn-cancel-edit"
                class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Cancel
              </button>
              <button id="btn-save-team"
                class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Save Changes
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Remove Member Confirmation Modal -->
      <div id="modal-remove-member" class="fixed inset-0 z-50 hidden" aria-labelledby="remove-modal-title" role="dialog"
        aria-modal="true">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
          <!-- Background overlay -->
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity" aria-hidden="true"></div>

          <!-- Modal panel -->
          <div
            class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
            <!-- Header -->
            <div class="bg-white px-6 py-4">
              <div class="flex items-center">
                <div
                  class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                  <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                </div>
                <div class="ml-4 text-left">
                  <h3 class="text-lg leading-6 font-semibold text-slate-900" id="remove-modal-title">
                    Remove Team Member
                  </h3>
                  <div class="mt-2">
                    <p class="text-sm text-slate-500">
                      Are you sure you want to remove <strong id="member-to-remove-name">this member</strong> from the
                      team? This action cannot be undone.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="bg-slate-50 px-6 py-3 flex items-center justify-end gap-3">
              <button id="btn-cancel-remove"
                class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Cancel
              </button>
              <button id="btn-confirm-remove"
                class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                Remove Member
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Team Confirmation Modal -->
      <div id="modal-delete-team" class="fixed inset-0 z-50 hidden" aria-labelledby="delete-modal-title" role="dialog"
        aria-modal="true">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
          <!-- Background overlay -->
          <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity" aria-hidden="true"></div>

          <!-- Modal panel -->
          <div
            class="inline-block align-bottom bg-white rounded-xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
            <!-- Header -->
            <div class="bg-white px-6 py-4">
              <div class="flex items-center">
                <div
                  class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                  <i data-lucide="trash-2" class="w-6 h-6 text-red-600"></i>
                </div>
                <div class="ml-4 text-left">
                  <h3 class="text-lg leading-6 font-semibold text-slate-900" id="delete-modal-title">
                    Delete Team
                  </h3>
                  <div class="mt-2">
                    <p class="text-sm text-slate-500">
                      Are you sure you want to delete <strong id="team-to-delete-name">this team</strong>? This will
                      remove all team members and cannot be undone.
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="bg-slate-50 px-6 py-3 flex items-center justify-end gap-3">
              <button id="btn-cancel-delete"
                class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Cancel
              </button>
              <button id="btn-confirm-delete"
                class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                Delete Team
              </button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Required: JavaScript -->
  <script type="module" data-tiramai="web-gen">
    import { showToast, showLoader, hideLoader, env } from "./scripts/main.js";
    import { auth, db, storage } from "./scripts/firebase.js";
    import { onAuthStateChanged, getAuth, signOut } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import { doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';

    // Initialize Lucide icons
    lucide.createIcons();

    // Global variables
    let currentUser = null;
    let userData = null;

    // Mobile menu functionality
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const mobileOverlay = document.getElementById('mobile-overlay');

    mobileMenuToggle?.addEventListener('click', () => {
      sidebar.classList.toggle('-translate-x-full');
      mobileOverlay.classList.toggle('hidden');
    });

    mobileOverlay?.addEventListener('click', () => {
      sidebar.classList.add('-translate-x-full');
      mobileOverlay.classList.add('hidden');
    });

    // User profile dropdown functionality
    const userProfileButton = document.getElementById('user-profile-button');
    const userDropdown = document.getElementById('user-dropdown');

    userProfileButton?.addEventListener('click', (e) => {
      e.stopPropagation();
      userDropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!userProfileButton?.contains(e.target) && !userDropdown?.contains(e.target)) {
        userDropdown?.classList.add('hidden');
      }
    });

    // Sign out functionality
    document.getElementById('sign-out-btn')?.addEventListener('click', async () => {
      try {
        showLoader('Signing out...');
        await signOut(auth);
        hideLoader();
        window.location.href = 'auth.html';
      } catch (error) {
        hideLoader();
        showToast('Failed to sign out: ' + error.message, 'error');
      }
    });

    // Initialize user profile
    async function initializeUserProfile(user) {
      currentUser = user;

      try {
        // Try to get user data from Firestore
        const userDocRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);

        if (userDoc.exists()) {
          userData = userDoc.data();
          updateUserUI(userData, user.email);
        } else {
          // Fallback to auth user data
          updateUserUI(null, user.email);
        }
      } catch (error) {
        console.error('Error fetching user data:', error);
        // Fallback to auth user data
        updateUserUI(null, user.email);
      }
    }

    // Update user UI elements
    function updateUserUI(userData, email) {
      const userAvatar = document.getElementById('user-avatar');
      const userDisplayName = document.getElementById('user-display-name');
      const dropdownUserName = document.getElementById('dropdown-user-name');
      const dropdownUserEmail = document.getElementById('dropdown-user-email');

      let displayName = 'User';
      let fullName = 'User';

      if (userData && userData.firstName) {
        displayName = userData.firstName;
        fullName = `${userData.firstName} ${userData.lastName || ''}`.trim();
      } else if (email) {
        displayName = email.split('@')[0];
        fullName = email;
      }

      // Update avatar with first letter
      if (userAvatar) {
        userAvatar.textContent = displayName.charAt(0).toUpperCase();
      }

      // Update display name
      if (userDisplayName) {
        userDisplayName.textContent = displayName;
      }

      // Update dropdown
      if (dropdownUserName) {
        dropdownUserName.textContent = fullName;
      }
      if (dropdownUserEmail) {
        dropdownUserEmail.textContent = email || 'No email';
      }
    }

    // Set active navigation item
    function setActiveNavItem() {
      const currentPage = window.location.pathname.replace('/', '').replace('.html', '') || 'admin_dashboard';

      document.querySelectorAll('.nav-item').forEach(item => {
        const pageName = item.getAttribute('data-page');
        if (pageName === currentPage) {
          item.classList.remove('text-slate-700', 'hover:bg-slate-100');
          item.classList.add('bg-blue-600', 'text-white');
        } else {
          item.classList.remove('bg-blue-600', 'text-white');
          item.classList.add('text-slate-700', 'hover:bg-slate-100');
        }
      });
    }

    // Auth state observer
    onAuthStateChanged(auth, (user) => {
      if (user) {
        initializeUserProfile(user);
        setActiveNavItem();
      } else {
        window.location.href = 'auth.html';
      }
    });

    // Set active nav item on page load
    setActiveNavItem();

    // Export for use in page-specific scripts
    window.appGlobals = {
      currentUser,
      userData,
      showToast,
      showLoader,
      hideLoader
    };
  </script>


  <script id="data-script" type="module" data-tiramai="web-gen">
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';
    import {
      collection, getDocs, doc, getDoc, deleteDoc, writeBatch, addDoc, updateDoc,
      query, where, orderBy, Timestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js';
    import { auth, getDb } from "./scripts/firebase.js";
    import { showToast, showLoader, hideLoader } from "./scripts/main.js";

    const db = getDb();
    let currentTeamId = null;
    let currentTeam = null;
    let teamMembers = [];
    let availableMembers = [];
    let selectedMemberIds = new Set();
    let memberToRemove = null;
    let currentAbort = null;

    // Utility function for micro-yields
    const yieldToFrame = () => new Promise(r => requestAnimationFrame(() => r()));

    // Semaphore for limiting concurrent operations
    function createSemaphore(max = 2) {
      const queue = [];
      let active = 0;
      const next = () => {
        if (active >= max || queue.length === 0) return;
        active++;
        const { fn, res, rej } = queue.shift();
        Promise.resolve()
          .then(fn)
          .then(v => res(v))
          .catch(e => rej(e))
          .finally(() => { active--; next(); });
      };
      return (fn) => new Promise((res, rej) => { queue.push({ fn, res, rej }); next(); });
    }
    const withLimit = createSemaphore(2);

    // Get team ID from URL
    function funGetTeamIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('teamId');
    }

    // Auth state observer
    onAuthStateChanged(auth, user => {
      if (!user) {
        location.href = "auth.html?redirect=" + encodeURIComponent(location.pathname + location.search);
      } else {
        currentTeamId = funGetTeamIdFromUrl();
        if (!currentTeamId) {
          showToast('Team ID is required', 'error');
          location.href = 'team_list.html';
          return;
        }
        funInitialLoad();
      }
    });

    // Initial data loading
    async function funInitialLoad(forceRefresh = false) {
      if (currentAbort) currentAbort.abort();
      currentAbort = new AbortController();
      const signal = currentAbort.signal;

      try {
        // Load team details and members concurrently but limit to 2 operations
        const [teamData, membersData] = await Promise.all([
          withLimit(() => funLoadTeamDetails(signal)),
          withLimit(() => funLoadTeamMembers(signal))
        ]);

        if (signal.aborted) return;

        if (teamData && membersData) {
          await yieldToFrame();
          funRenderTeamHeader(teamData);
          funRenderMembersTable(membersData);
        }
      } catch (error) {
        if (!signal.aborted) {
          console.error('Error in initial load:', error);
          showToast('Failed to load team data', 'error');
        }
      }
    }

    // Load team details
    async function funLoadTeamDetails(signal) {
      try {
        const teamRef = doc(db, 'teams', currentTeamId);
        const teamDoc = await getDoc(teamRef);

        if (signal?.aborted) return null;

        if (!teamDoc.exists()) {
          showToast('Team not found', 'error');
          location.href = 'team_list.html';
          return null;
        }

        const teamData = { id: teamDoc.id, ...teamDoc.data() };
        currentTeam = teamData;
        return teamData;
      } catch (error) {
        if (!signal?.aborted) {
          console.error('Error loading team details:', error);
          throw error;
        }
        return null;
      }
    }

    // Load team members with roles
    async function funLoadTeamMembers(signal) {
      try {
        // Get team member relationships
        const teamMembersQuery = query(
          collection(db, 'teamMembers'),
          where('teamId', '==', currentTeamId),
          orderBy('joinedAt', 'desc')
        );

        const teamMembersSnapshot = await getDocs(teamMembersQuery);
        if (signal?.aborted) return null;

        const memberIds = teamMembersSnapshot.docs.map(doc => ({
          id: doc.id,
          memberId: doc.data().memberId,
          joinedAt: doc.data().joinedAt
        }));

        if (memberIds.length === 0) {
          teamMembers = [];
          return [];
        }

        // Get member details
        const membersPromises = memberIds.map(async ({ memberId, joinedAt }) => {
          const memberRef = doc(db, 'members', memberId);
          const memberDoc = await getDoc(memberRef);
          if (!memberDoc.exists()) return null;

          return {
            id: memberDoc.id,
            ...memberDoc.data(),
            joinedAt
          };
        });

        let members = await Promise.all(membersPromises);
        members = members.filter(Boolean); // Remove null entries

        if (signal?.aborted) return null;

        // Get roles for all members
        for (const member of members) {
          member.roles = await funGetMemberRoles(member.id, signal);
          if (signal?.aborted) return null;
        }

        teamMembers = members;
        return members;
      } catch (error) {
        if (!signal?.aborted) {
          console.error('Error loading team members:', error);
          throw error;
        }
        return null;
      }
    }

    // Get roles for a specific member
    async function funGetMemberRoles(memberId, signal) {
      try {
        const memberRolesQuery = query(
          collection(db, 'memberRoles'),
          where('memberId', '==', memberId)
        );

        const memberRolesSnapshot = await getDocs(memberRolesQuery);
        if (signal?.aborted) return [];

        const roleIds = memberRolesSnapshot.docs.map(doc => doc.data().roleId);
        if (roleIds.length === 0) return [];

        const rolesPromises = roleIds.map(async roleId => {
          const roleRef = doc(db, 'roles', roleId);
          const roleDoc = await getDoc(roleRef);
          return roleDoc.exists() ? { id: roleDoc.id, ...roleDoc.data() } : null;
        });

        const roles = await Promise.all(rolesPromises);
        return roles.filter(Boolean);
      } catch (error) {
        if (!signal?.aborted) {
          console.error('Error loading member roles:', error);
        }
        return [];
      }
    }

    // Render team header
    function funRenderTeamHeader(team) {
      const teamName = document.getElementById('team-name');
      const teamMeta = document.getElementById('team-meta');
      const memberCountBadge = document.getElementById('member-count-badge');
      const teamToDeleteName = document.getElementById('team-to-delete-name');

      if (teamName && team?.name) {
        teamName.textContent = team.name;
      }

      if (teamMeta && team?.createdAt) {
        const createdDate = team.createdAt ? new Date(team.createdAt).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        }) : 'N/A';
        teamMeta.textContent = `Created on ${createdDate}`;
      }

      if (memberCountBadge) {
        const count = teamMembers?.length || 0;
        memberCountBadge.textContent = `${count} member${count !== 1 ? 's' : ''}`;
      }

      if (teamToDeleteName && team?.name) {
        teamToDeleteName.textContent = team.name;
      }
    }

    // Render members table
    function funRenderMembersTable(members) {
      const skeleton = document.getElementById('members-skeleton');
      const table = document.getElementById('members-table');
      const tbody = document.getElementById('members-table-body');
      const emptyState = document.getElementById('members-empty-state');

      // Hide skeleton
      if (skeleton) skeleton.classList.add('hidden');

      if (!members || members.length === 0) {
        if (table) table.classList.add('hidden');
        if (emptyState) emptyState.classList.remove('hidden');
        return;
      }

      if (emptyState) emptyState.classList.add('hidden');
      if (table) table.classList.remove('hidden');

      if (tbody) {
        tbody.innerHTML = '';

        members.forEach(member => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-slate-50';

          // Member name and avatar
          const memberCell = document.createElement('td');
          memberCell.className = 'px-6 py-4 whitespace-nowrap';
          memberCell.innerHTML = `
          <div class="flex items-center">
            <div class="flex-shrink-0 h-10 w-10">
              <div class="h-10 w-10 rounded-full bg-slate-300 flex items-center justify-center text-sm font-medium text-white">
                ${member?.name ? member.name.charAt(0).toUpperCase() : 'M'}
              </div>
            </div>
            <div class="ml-4">
              <a href="member_detail.html?memberId=${member.id}" class="text-sm font-medium text-blue-600 hover:text-blue-800">
                ${member?.name || 'N/A'}
              </a>
            </div>
          </div>
        `;

          // Email
          const emailCell = document.createElement('td');
          emailCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-slate-900';
          emailCell.textContent = member?.email || 'N/A';

          // Roles
          const rolesCell = document.createElement('td');
          rolesCell.className = 'px-6 py-4 whitespace-nowrap';
          if (member.roles && member.roles.length > 0) {
            const rolesHtml = member.roles.map(role =>
              `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-1">${role.name}</span>`
            ).join('');
            rolesCell.innerHTML = rolesHtml;
          } else {
            rolesCell.innerHTML = '<span class="text-sm text-slate-500">No roles assigned</span>';
          }

          // Joined date
          const joinedCell = document.createElement('td');
          joinedCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-slate-500';
          if (member.joinedAt) {
            const joinedDate = new Date(member.joinedAt).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            });
            joinedCell.textContent = joinedDate;
          } else {
            joinedCell.textContent = 'N/A';
          }

          // Actions
          const actionsCell = document.createElement('td');
          actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
          actionsCell.innerHTML = `
          <button class="text-red-600 hover:text-red-900 remove-member-btn" data-member-id="${member.id}" data-member-name="${member?.name || 'Member'}">
            Remove
          </button>
        `;

          row.appendChild(memberCell);
          row.appendChild(emailCell);
          row.appendChild(rolesCell);
          row.appendChild(joinedCell);
          row.appendChild(actionsCell);
          tbody.appendChild(row);
        });

        // Add event listeners for remove buttons
        tbody.querySelectorAll('.remove-member-btn').forEach(btn => {
          btn.addEventListener('click', funHandleRemoveMemberClick);
        });
      }
    }

    // Load available members for adding
    async function funLoadAvailableMembers(signal) {
      try {
        // Get all members
        const membersQuery = query(collection(db, 'members'), orderBy('name'));
        const membersSnapshot = await getDocs(membersQuery);

        if (signal?.aborted) return [];

        const allMembers = membersSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // Filter out current team members
        const currentMemberIds = new Set(teamMembers.map(m => m.id));
        availableMembers = allMembers.filter(member => !currentMemberIds.has(member.id));

        return availableMembers;
      } catch (error) {
        if (!signal?.aborted) {
          console.error('Error loading available members:', error);
          throw error;
        }
        return [];
      }
    }

    // Render available members in modal
    function funRenderAvailableMembers(members, searchTerm = '') {
      const skeleton = document.getElementById('available-members-skeleton');
      const container = document.getElementById('available-members-container');
      const noAvailable = document.getElementById('no-available-members');
      const noSearchResults = document.getElementById('no-search-results');

      // Hide skeleton
      if (skeleton) skeleton.classList.add('hidden');

      // Filter members based on search
      const filteredMembers = members.filter(member => {
        if (!searchTerm) return true;
        const term = searchTerm.toLowerCase();
        return (
          (member.name?.toLowerCase() || '').includes(term) ||
          (member.email?.toLowerCase() || '').includes(term)
        );
      });

      // Show appropriate state
      if (members.length === 0) {
        if (container) container.classList.add('hidden');
        if (noSearchResults) noSearchResults.classList.add('hidden');
        if (noAvailable) noAvailable.classList.remove('hidden');
        return;
      }

      if (filteredMembers.length === 0 && searchTerm) {
        if (container) container.classList.add('hidden');
        if (noAvailable) noAvailable.classList.add('hidden');
        if (noSearchResults) noSearchResults.classList.remove('hidden');
        return;
      }

      // Hide empty states
      if (noAvailable) noAvailable.classList.add('hidden');
      if (noSearchResults) noSearchResults.classList.add('hidden');
      if (container) container.classList.remove('hidden');

      // Render filtered members
      if (container) {
        container.innerHTML = '';

        filteredMembers.forEach(member => {
          const memberDiv = document.createElement('div');
          memberDiv.className = 'flex items-center p-3 rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors';

          memberDiv.innerHTML = `
          <input type="checkbox" id="member-${member.id}" class="member-checkbox h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-slate-300 rounded" data-member-id="${member.id}">
          <label for="member-${member.id}" class="ml-3 flex items-center flex-1 cursor-pointer">
            <div class="flex-shrink-0 h-8 w-8">
              <div class="h-8 w-8 rounded-full bg-slate-300 flex items-center justify-center text-sm font-medium text-white">
                ${member?.name ? member.name.charAt(0).toUpperCase() : 'M'}
              </div>
            </div>
            <div class="ml-3 flex-1">
              <p class="text-sm font-medium text-slate-900">${member?.name || 'N/A'}</p>
              <p class="text-xs text-slate-500">${member?.email || 'N/A'}</p>
            </div>
          </label>
        `;

          container.appendChild(memberDiv);
        });

        // Add event listeners
        container.querySelectorAll('.member-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', funHandleMemberSelection);
        });
      }
    }

    // Handle member selection
    function funHandleMemberSelection() {
      const checkboxes = document.querySelectorAll('.member-checkbox');
      selectedMemberIds.clear();

      checkboxes.forEach(cb => {
        if (cb.checked) {
          selectedMemberIds.add(cb.dataset.memberId);
        }
      });

      // Update UI
      const selectedCount = document.getElementById('selected-count');
      const saveBtn = document.getElementById('btn-save-members');
      const selectAllCheckbox = document.getElementById('select-all-members');

      if (selectedCount) {
        selectedCount.textContent = selectedMemberIds.size;
      }

      if (saveBtn) {
        saveBtn.disabled = selectedMemberIds.size === 0;
      }

      // Update select all checkbox
      if (selectAllCheckbox) {
        const totalCheckboxes = checkboxes.length;
        const checkedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked).length;

        if (checkedCheckboxes === 0) {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = false;
        } else if (checkedCheckboxes === totalCheckboxes) {
          selectAllCheckbox.checked = true;
          selectAllCheckbox.indeterminate = false;
        } else {
          selectAllCheckbox.checked = false;
          selectAllCheckbox.indeterminate = true;
        }
      }
    }

    // Handle remove member click
    function funHandleRemoveMemberClick(event) {
      const btn = event.target;
      const memberId = btn.dataset.memberId;
      const memberName = btn.dataset.memberName;

      memberToRemove = { id: memberId, name: memberName };

      const memberToRemoveName = document.getElementById('member-to-remove-name');
      if (memberToRemoveName) {
        memberToRemoveName.textContent = memberName;
      }

      const modal = document.getElementById('modal-remove-member');
      if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      }
    }

    // Save selected members to team
    async function funSaveSelectedMembers() {
      if (selectedMemberIds.size === 0) return;

      showLoader('Adding members to team...');

      try {
        const batch = writeBatch(db);
        const timestamp = Timestamp.now().toDate().toISOString();

        // Add team member relationships
        for (const memberId of selectedMemberIds) {
          const teamMemberRef = doc(collection(db, 'teamMembers'));
          batch.set(teamMemberRef, {
            teamId: currentTeamId,
            memberId: memberId,
            joinedAt: timestamp
          });
        }

        await batch.commit();

        hideLoader();
        showToast(`Successfully added ${selectedMemberIds.size} member(s) to the team`, 'success');

        // Close modal and refresh data
        funCloseAddMembersModal();
        await funInitialLoad();
      } catch (error) {
        hideLoader();
        console.error('Error adding members:', error);
        showToast('Failed to add members to team', 'error');
      }
    }

    // Remove member from team
    async function funRemoveMemberFromTeam() {
      if (!memberToRemove) return;

      showLoader('Removing member from team...');

      try {
        // Find and delete team member relationship
        const teamMembersQuery = query(
          collection(db, 'teamMembers'),
          where('teamId', '==', currentTeamId),
          where('memberId', '==', memberToRemove.id)
        );

        const snapshot = await getDocs(teamMembersQuery);
        if (!snapshot.empty) {
          const docToDelete = snapshot.docs[0];
          await deleteDoc(docToDelete.ref);
        }

        hideLoader();
        showToast(`${memberToRemove.name} removed from team`, 'success');

        // Close modal and refresh
        funCloseRemoveMemberModal();
        await funInitialLoad();
      } catch (error) {
        hideLoader();
        console.error('Error removing member:', error);
        showToast('Failed to remove member from team', 'error');
      }
    }

    // Delete entire team
    async function funDeleteTeam() {
      if (!currentTeam) return;

      showLoader('Deleting team...');

      try {
        const batch = writeBatch(db);

        // Delete all team member relationships
        const teamMembersQuery = query(
          collection(db, 'teamMembers'),
          where('teamId', '==', currentTeamId)
        );
        const teamMembersSnapshot = await getDocs(teamMembersQuery);

        teamMembersSnapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });

        // Delete the team
        const teamRef = doc(db, 'teams', currentTeamId);
        batch.delete(teamRef);

        await batch.commit();

        hideLoader();
        showToast('Team deleted successfully', 'success');
        location.href = 'team_list.html';
      } catch (error) {
        hideLoader();
        console.error('Error deleting team:', error);
        showToast('Failed to delete team', 'error');
      }
    }

    // Modal management functions
    function funOpenAddMembersModal() {
      selectedMemberIds.clear();

      const modal = document.getElementById('modal-add-members');
      const searchInput = document.getElementById('member-search');

      if (modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      }

      if (searchInput) {
        searchInput.value = '';
      }

      // Load available members
      funLoadAvailableMembers().then(members => {
        funRenderAvailableMembers(members);
      }).catch(error => {
        console.error('Error loading available members:', error);
        showToast('Failed to load available members', 'error');
      });
    }

    function funCloseAddMembersModal() {
      const modal = document.getElementById('modal-add-members');
      if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
      selectedMemberIds.clear();
    }

    function funCloseRemoveMemberModal() {
      const modal = document.getElementById('modal-remove-member');
      if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
      memberToRemove = null;
    }

    function funCloseEditTeamModal() {
      const modal = document.getElementById('modal-edit-team');
      if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
    }

    async function funSaveTeamEdit() {
      const newName = document.getElementById('edit-team-name')?.value?.trim();

      if (!newName) {
        showToast('Team name cannot be empty', 'error');
        return;
      }

      if (!currentTeamId) {
        showToast('Team ID not found', 'error');
        return;
      }

      try {
        showLoader('Updating team...');

        const teamDocRef = doc(db, 'teams', currentTeamId);
        await updateDoc(teamDocRef, {
          name: newName,
          updatedAt: new Date().toISOString()
        });

        showToast('Team updated successfully', 'success');
        funCloseEditTeamModal();

        // Reload team data
        await funInitialLoad();
      } catch (error) {
        console.error('Error updating team:', error);
        showToast('Failed to update team: ' + error.message, 'error');
      } finally {
        hideLoader();
      }
    }

    function funCloseDeleteTeamModal() {
      const modal = document.getElementById('modal-delete-team');
      if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }
    }

    // Search functionality with debounce
    let searchTimeout;
    function funDebounceSearch(searchTerm) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        funRenderAvailableMembers(availableMembers, searchTerm);
      }, 300);
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }

      // Back button
      document.getElementById('btn-back')?.addEventListener('click', () => {
        location.href = 'team_list.html';
      });

      // Refresh button
      document.getElementById('btn-refresh')?.addEventListener('click', () => {
        funInitialLoad(true);
      });

      // Edit team button
      document.getElementById('btn-edit-team')?.addEventListener('click', () => {
        if (currentTeamId) {
          const modal = document.getElementById('modal-edit-team');
          const teamNameInput = document.getElementById('edit-team-name');
          const currentTeamName = document.getElementById('team-name')?.textContent || '';

          if (modal && teamNameInput) {
            teamNameInput.value = currentTeamName;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            teamNameInput.focus();
          }
        }
      });

      // Delete team button
      document.getElementById('btn-delete-team')?.addEventListener('click', () => {
        const modal = document.getElementById('modal-delete-team');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
        }
      });

      // Add members buttons
      document.getElementById('btn-add-members')?.addEventListener('click', funOpenAddMembersModal);
      document.getElementById('btn-add-members-empty')?.addEventListener('click', funOpenAddMembersModal);

      // Add members modal controls
      document.getElementById('btn-close-add-modal')?.addEventListener('click', funCloseAddMembersModal);
      document.getElementById('btn-cancel-add')?.addEventListener('click', funCloseAddMembersModal);
      document.getElementById('btn-save-members')?.addEventListener('click', funSaveSelectedMembers);

      // Edit team modal controls
      document.getElementById('btn-close-edit-modal')?.addEventListener('click', funCloseEditTeamModal);
      document.getElementById('btn-cancel-edit')?.addEventListener('click', funCloseEditTeamModal);
      document.getElementById('btn-save-team')?.addEventListener('click', funSaveTeamEdit);

      // Close edit modal when clicking on background
      document.getElementById('modal-edit-team')?.addEventListener('click', (e) => {
        if (e.target.id === 'modal-edit-team') {
          funCloseEditTeamModal();
        }
      });

      // Search input
      document.getElementById('member-search')?.addEventListener('input', (e) => {
        funDebounceSearch(e.target.value);
      });

      // Select all controls
      document.getElementById('select-all-members')?.addEventListener('change', (e) => {
        const checkboxes = document.querySelectorAll('.member-checkbox');
        checkboxes.forEach(cb => {
          cb.checked = e.target.checked;
        });
        funHandleMemberSelection();
      });

      document.getElementById('btn-select-all')?.addEventListener('click', () => {
        const checkboxes = document.querySelectorAll('.member-checkbox');
        checkboxes.forEach(cb => {
          cb.checked = true;
        });
        funHandleMemberSelection();
      });

      document.getElementById('btn-deselect-all')?.addEventListener('click', () => {
        const checkboxes = document.querySelectorAll('.member-checkbox');
        checkboxes.forEach(cb => {
          cb.checked = false;
        });
        funHandleMemberSelection();
      });

      // Remove member modal controls
      document.getElementById('btn-cancel-remove')?.addEventListener('click', funCloseRemoveMemberModal);
      document.getElementById('btn-confirm-remove')?.addEventListener('click', funRemoveMemberFromTeam);

      // Delete team modal controls
      document.getElementById('btn-cancel-delete')?.addEventListener('click', funCloseDeleteTeamModal);
      document.getElementById('btn-confirm-delete')?.addEventListener('click', funDeleteTeam);

      // Close modals on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          funCloseAddMembersModal();
          funCloseRemoveMemberModal();
          funCloseDeleteTeamModal();
        }
      });

      // Close modals on backdrop click
      document.getElementById('modal-add-members')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          funCloseAddMembersModal();
        }
      });

      document.getElementById('modal-remove-member')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          funCloseRemoveMemberModal();
        }
      });

      document.getElementById('modal-delete-team')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          funCloseDeleteTeamModal();
        }
      });
    });
  </script>

</body>

</html>